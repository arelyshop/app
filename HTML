<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema POS e Inventario - ArelyShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Librerías para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3b82f6; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active { border-color: #2c3c53; color: #2c3c53; font-weight: 600; }
        .tab-inactive { border-color: transparent; color: #6b7280; }
        .tab-content { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        <div class="mb-8 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-pos" class="px-3 py-2 text-sm font-medium border-b-2 tab-active">Punto de Venta</button>
                <button id="tab-inventory" class="px-3 py-2 text-sm font-medium border-b-2 tab-inactive">Gestionar Inventario</button>
                <button id="tab-sales-query" class="px-3 py-2 text-sm font-medium border-b-2 tab-inactive">Consultar Ventas</button>
            </nav>
        </div>

        <!-- Pestaña: Punto de Venta -->
        <div id="content-pos" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6 flex justify-between items-center" style="background-color: #2c3c53; color: white;">
                        <div class="flex items-center">
                            <img src="https://dcdn-us.mitiendanube.com/stores/004/546/736/themes/common/logo-660776128-1736645739-9bb5db1715d3b799cdf782b0f0815d541736645739.webp?0" alt="Logo ArelyShop" class="h-12 mr-4" onerror="this.style.display='none'">
                            <div class="hidden md:block">
                                <h2 class="font-bold text-xl">ArelyShop</h2>
                                <p class="text-xs">Santa Cruz de la Sierra, Bolivia</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <h3 class="font-bold text-lg">Nota de Venta</h3>
                            <p class="text-sm">Nr: <span id="current-sale-id">--</span></p>
                            <p class="text-sm">Fecha: <span id="current-date">--/--/----</span></p>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="relative mb-4">
                            <label for="search-product" class="block text-sm font-medium text-gray-700 mb-1">Buscar Producto (Nombre, SKU o Código de Barras)</label>
                            <input type="text" id="search-product" placeholder="Escanear código de barras o escribir para buscar..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <div id="search-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-3">Carrito</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Precio Unit.</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Subtotal</th>
                                        <th class="px-4 py-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="cart-items" class="bg-white divide-y divide-gray-200">
                                    <tr id="empty-cart-row"><td colspan="5" class="text-center py-8 text-gray-500">El carrito está vacío</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 h-fit">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Detalles del Cliente</h3>
                    <form id="customer-form" class="space-y-4">
                        <div><label for="customer-name" class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="customer-name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="customer-contact" class="block text-sm font-medium text-gray-700">Contacto</label><input type="text" id="customer-contact" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="customer-id" class="block text-sm font-medium text-gray-700">NIT/CI</label><input type="text" id="customer-id" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                    </form>
                    <div class="border-t border-gray-200 mt-6 pt-6">
                        <div class="flex justify-between items-center text-2xl font-bold text-gray-800"><span>TOTAL:</span><span id="total-amount">Bs 0.00</span></div>
                        <button id="finalize-sale-button" class="mt-6 w-full inline-flex items-center justify-center px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-200 shadow-lg disabled:bg-gray-400">
                            <span id="sale-button-text" class="inline-flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF" class="mr-2"><path d="M280-640q-33 0-56.5-23.5T200-720v-80q0-33 23.5-56.5T280-880h400q33 0 56.5 23.5T760-800v80q0 33-23.5 56.5T680-640H280Zm0-80h400v-80H280v80ZM160-80q-33 0-56.5-23.5T80-160v-40h800v40q0 33-23.5 56.5T800-80H160ZM80-240l139-313q10-22 30-34.5t43-12.5h376q23 0 43 12.5t30 34.5l139 313H80Zm260-80h40q8 0 14-6t6-14q0-8-6-14t-14-6h-40q-8 0-14 6t-6 14q0 8 6 14t14 6Zm0-80h40q8 0 14-6t6-14q0-8-6-14t-14-6h-40q-8 0-14 6t-6 14q0 8 6 14t14 6Zm0-80h40q8 0 14-6t6-14q0-8-6-14t-14-6h-40q-8 0-14 6t-6 14q0 8 6 14t14 6Zm120 160h40q8 0 14-6t6-14q0-8-6-14t-14-6h-40q-8 0-14 6t-6 14q0 8 6 14t14 6Zm0-80h40q8 0 14-6t6-14q0-8-6-14t-14-6h-40q-8 0-14 6t-6 14q0 8 6 14t14 6Zm0-80h40q8 0 14-6t6-14q0-8-6-14t-14-6h-40q-8 0-14 6t-6 14q0 8 6 14t14 6Zm120 160h40q8 0 14-6t6-14q0-8-6-14t-14-6h-40q-8 0-14 6t-6 14q0 8 6 14t14 6Zm0-80h40q8 0 14-6t6-14q0-8-6-14t-14-6h-40q-8 0-14 6t-6 14q0 8 6 14t14 6Zm0-80h40q8 0 14-6t6-14q0-8-6-14t-14-6h-40q-8 0-14 6t-6 14q0 8 6 14t14 6Z"/></svg>
                                Completar Venta
                            </span>
                            <div id="sale-loader" class="loader hidden"></div>
                        </button>
                        <button id="generate-quote-button" class="mt-2 w-full inline-flex items-center justify-center px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-lg disabled:bg-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF" class="mr-2"><path d="M240-80q-50 0-85-35t-35-85v-120h120v-560h600v680q0 50-35 85t-85 35H240Zm480-80q17 0 28.5-11.5T760-200v-600H320v480h360v120q0 17 11.5 28.5T720-160ZM360-600v-80h360v80H360Zm0 120v-80h360v80H360ZM240-160h360v-80H200v40q0 17 11.5 28.5T240-160Zm0 0h-40 400-360Z"/></svg>
                            Cotización
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña: Gestionar Inventario -->
        <div id="content-inventory" class="tab-content">
             <div class="w-full max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-8 md:p-12">
                <div class="text-center mb-10">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Registrar Nuevo Producto</h1>
                    <p class="text-gray-500 mt-2">Completa los campos para añadir un artículo al inventario.</p>
                </div>
                <form id="inventory-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto</label><input type="text" id="nombre" name="nombre" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="sku" class="block text-sm font-medium text-gray-700 mb-1">SKU</label><input type="text" id="sku" name="sku" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><label for="precioVenta" class="block text-sm font-medium text-gray-700 mb-1">Precio (Venta)</label><input type="number" step="0.01" id="precioVenta" name="precioVenta" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="precioCompra" class="block text-sm font-medium text-gray-700 mb-1">Precio (Compra)</label><input type="number" step="0.01" id="precioCompra" name="precioCompra" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="precioMayoreo" class="block text-sm font-medium text-gray-700 mb-1">Precio (Mayoreo)</label><input type="number" step="0.01" id="precioMayoreo" name="precioMayoreo" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="cantidad" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label><input type="number" id="cantidad" name="cantidad" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                        <div><label for="codigoBarras" class="block text-sm font-medium text-gray-700 mb-1">Código de Barras</label><input type="text" id="codigoBarras" name="codigoBarras" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                    </div>
                    <div><label for="urlFoto1" class="block text-sm font-medium text-gray-700 mb-1">URL de la Foto</label><input type="text" id="urlFoto1" name="urlFoto1" placeholder="https://ejemplo.com/imagen.jpg" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                    <div class="flex items-center justify-end pt-4">
                        <button type="submit" id="inventory-submit-button" class="inline-flex items-center justify-center px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">
                            <span id="inventory-button-text">Registrar Producto</span>
                            <div id="inventory-loader" class="loader hidden ml-3"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pestaña: Consultar Ventas -->
        <div id="content-sales-query" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Consultar Ventas</h2>
                <input type="text" id="search-sales-input" placeholder="Buscar por Nro. Venta, Cliente o Contacto..." class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-6">
                <div id="sales-results-container" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación para Anular Venta -->
    <div id="annul-confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Anular Venta</h3>
                <div class="mt-2 px-7 py-3"><p id="annul-modal-text" class="text-sm text-gray-500">¿Estás seguro? Esta acción no se puede deshacer y el stock será restaurado.</p></div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-annul-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-lg w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">Confirmar Anulación</button>
                    <button id="cancel-annul-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-lg w-auto ml-2 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // URL del script de Google Apps que actúa como backend.
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwxHgB0QiAvw_KA3ple8PlHIcOOcpHjCZfvrhRZB7obM6BDmI30Ff5Ltx1e8mEEERXw/exec';
        
        // Variables globales para almacenar datos
        let products = [];
        let sales = [];
        let cart = [];
        let saleIdToAnnul = null;
        let preloadedLogo = null;
        let preloadedQr = null;

        // Función para cargar imágenes y convertirlas a PNG (para preservar transparencia)
        const loadImageAsPngDataUrl = (url) => new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const dataURL = canvas.toDataURL('image/png');
                resolve({dataURL, width: img.width, height: img.height});
            };
            img.onerror = () => resolve(null); // Resuelve como null si hay un error
            // Añade un parámetro para evitar problemas de caché con CORS
            img.src = url + (url.includes('?') ? '&' : '?') + new Date().getTime();
        });

        // Función para cargar imágenes y convertirlas a JPEG (para compresión y tamaño de archivo más pequeño)
        const loadImageAsJpegDataUrl = (url) => new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const dataURL = canvas.toDataURL('image/jpeg', 0.8); // 80% de calidad
                resolve({dataURL, width: img.width, height: img.height});
            };
            img.onerror = () => resolve(null); // Resuelve como null si hay un error
            img.src = url + (url.includes('?') ? '&' : '?') + new Date().getTime();
        });

        // Evento que se dispara cuando el DOM está completamente cargado
        document.addEventListener('DOMContentLoaded', async () => {
            initTabs();
            // Carga inicial de datos de productos y ventas en paralelo
            await Promise.all([
                fetchProducts(),
                fetchSales()
            ]);

            // Precargar imágenes para el PDF para que estén listas cuando se necesiten
            const logoUrl = 'https://dcdn-us.mitiendanube.com/stores/004/546/736/themes/common/logo-660776128-1736645739-9bb5db1715d3b799cdf782b0f0815d541736645739.webp';
            const qrCodeUrl = 'https://lh3.googleusercontent.com/d/1T_RjD_7DgdNrfkIf8lLRDdxziDAg_wjZ=w800?authuser=0';
            [preloadedLogo, preloadedQr] = await Promise.all([
                loadImageAsPngDataUrl(logoUrl),
                loadImageAsJpegDataUrl(qrCodeUrl)
            ]);
            
            // Configuración de todos los event listeners de la página
            setupEventListeners();

            // Poner la fecha actual en la interfaz
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('es-BO');
        });

        // Inicializa la funcionalidad de las pestañas
        function initTabs() {
            const tabs = {
                pos: { btn: document.getElementById('tab-pos'), content: document.getElementById('content-pos') },
                inventory: { btn: document.getElementById('tab-inventory'), content: document.getElementById('content-inventory') },
                salesQuery: { btn: document.getElementById('tab-sales-query'), content: document.getElementById('content-sales-query') }
            };

            Object.keys(tabs).forEach(key => {
                tabs[key].btn.addEventListener('click', () => {
                    // Ocultar todas las pestañas y desactivar botones
                    Object.values(tabs).forEach(t => {
                        t.btn.classList.remove('tab-active');
                        t.btn.classList.add('tab-inactive');
                        t.content.style.display = 'none';
                    });
                    // Mostrar la pestaña seleccionada y activar su botón
                    tabs[key].btn.classList.add('tab-active');
                    tabs[key].btn.classList.remove('tab-inactive');
                    tabs[key].content.style.display = 'block';

                    // Si se hace clic en la pestaña de consulta de ventas, se cargan los datos
                    if (key === 'salesQuery') {
                        fetchSales();
                    }
                });
            });
            // Mostrar la pestaña de punto de venta por defecto
            tabs.pos.content.style.display = 'block';
        }

        // Centraliza la configuración de todos los event listeners
        function setupEventListeners() {
            const searchInput = document.getElementById('search-product');
            searchInput.addEventListener('input', handleSearch);
            searchInput.addEventListener('keydown', handleBarcodeScan);

            document.getElementById('search-sales-input').addEventListener('input', renderSalesResults);
            document.getElementById('finalize-sale-button').addEventListener('click', finalizeSale);
            document.getElementById('inventory-form').addEventListener('submit', handleAddProduct);
            document.getElementById('generate-quote-button').addEventListener('click', handleGenerateQuote);

            // Eventos para el modal de confirmación de anulación
            document.getElementById('cancel-annul-btn').addEventListener('click', () => {
                document.getElementById('annul-confirm-modal').classList.add('hidden');
            });
            document.getElementById('confirm-annul-btn').addEventListener('click', () => {
                if (saleIdToAnnul) {
                    annulSaleInBackend(saleIdToAnnul);
                }
                document.getElementById('annul-confirm-modal').classList.add('hidden');
            });
        }
        
        // Obtiene la lista de productos del backend (Google Sheets)
        async function fetchProducts() {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({ action: 'getProducts' })
                });
                const result = await response.json();
                products = result.status === 'success' ? result.data : [];
            } catch (error) {
                console.error("Error de red al obtener productos:", error);
                alert("No se pudieron cargar los productos. Revisa la conexión y la URL del script.");
            }
        }

        // Obtiene el historial de ventas del backend
        async function fetchSales() {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({ action: 'getSales' })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    // Ordena las ventas de más reciente a más antigua
                    sales = result.data.sort((a, b) => {
                        const numA = parseInt((a['Nro. Venta'] || "AS0").substring(2)); // CHANGED
                        const numB = parseInt((b['Nro. Venta'] || "AS0").substring(2)); // CHANGED
                        return numB - numA;
                    });
                    displayNextSaleId();
                    renderSalesResults();
                }
            } catch (error) {
                console.error("Error de red al obtener ventas:", error);
            }
        }
        
        // Muestra el número de la siguiente venta en la interfaz
        function displayNextSaleId() {
            let nextId = "AS1"; // CHANGED
            if (sales.length > 0 && sales[0]['Nro. Venta']) {
                const lastSaleId = sales[0]['Nro. Venta'];
                const lastIdNumber = parseInt(lastSaleId.substring(2));
                if (!isNaN(lastIdNumber)) {
                    nextId = 'AS' + (lastIdNumber + 1); // CHANGED
                }
            }
            document.getElementById('current-sale-id').textContent = nextId;
        }

        // Maneja el escaneo de código de barras (al presionar Enter)
        function handleBarcodeScan(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const barcode = e.target.value.trim();
                if (barcode === '') return;
                const foundProduct = products.find(p => p['Código de Barras']?.toString() === barcode);
                if (foundProduct) {
                    addToCart(foundProduct);
                    e.target.value = '';
                } else {
                    alert('Producto no encontrado con ese código de barras.');
                }
            }
        }

        // Maneja la búsqueda de productos por texto
        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
                return;
            }
            const filteredProducts = products.filter(p => 
                p['Nombre']?.toLowerCase().includes(searchTerm) ||
                p['SKU']?.toString().toLowerCase().includes(searchTerm)
            );
            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = '';
            if (filteredProducts.length > 0) {
                filteredProducts.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'p-3 hover:bg-gray-100 cursor-pointer';
                    div.textContent = `${p['Nombre']} (Bs ${p['Precio (Venta)']}) - Stock: ${p['Cantidad']}`;
                    div.onclick = () => addToCart(p);
                    resultsContainer.appendChild(div);
                });
            } else {
                resultsContainer.innerHTML = '<div class="p-3 text-gray-500">No se encontraron productos</div>';
            }
        }

        // Añade un producto al carrito
        function addToCart(product) {
            const existingCartItem = cart.find(item => item['SKU'] === product['SKU'] && item['Nombre'] === product['Nombre']);
            if (existingCartItem) {
                existingCartItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1, customPrice: parseFloat(product['Precio (Venta)']) });
            }
            document.getElementById('search-product').value = '';
            document.getElementById('search-results').classList.add('hidden');
            renderCart();
        }

        // Dibuja la tabla del carrito en la interfaz
        function renderCart() {
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<tr id="empty-cart-row"><td colspan="5" class="text-center py-8 text-gray-500">El carrito está vacío</td></tr>';
            } else {
                cart.forEach((item, index) => {
                    const subtotal = item.quantity * item.customPrice;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-800 align-middle">${item['Nombre']}</td>
                        <td class="px-4 py-3 text-sm align-middle"><input type="number" step="0.01" value="${item.customPrice.toFixed(2)}" onchange="updateItemPrice(${index}, this.value)" class="w-24 text-center border rounded-lg py-1"></td>
                        <td class="px-4 py-3 text-sm text-center align-middle"><input type="number" min="1" value="${item.quantity}" onchange="setQuantity(${index}, this.value)" class="w-20 text-center border rounded-lg py-1"></td>
                        <td class="px-4 py-3 text-sm text-right font-medium align-middle">Bs ${subtotal.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center align-middle"><button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></td>
                    `;
                    cartItemsContainer.appendChild(row);
                });
            }
            updateTotal();
        }
        
        // Actualiza el precio de un item en el carrito
        function updateItemPrice(index, newPrice) {
            const price = parseFloat(newPrice);
            if (!isNaN(price) && price >= 0) cart[index].customPrice = price;
            renderCart();
        }

        // Actualiza la cantidad de un item en el carrito
        function setQuantity(index, newQuantity) {
            const quantity = parseInt(newQuantity);
            if (!isNaN(quantity) && quantity > 0) {
                cart[index].quantity = quantity;
            } else {
                cart[index].quantity = 1;
            }
            renderCart();
        }

        // Remueve un item del carrito
        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        // Actualiza el total de la venta y habilita/deshabilita botones
        function updateTotal() {
            const total = cart.reduce((sum, item) => sum + (item.quantity * item.customPrice), 0);
            document.getElementById('total-amount').textContent = `Bs ${total.toFixed(2)}`;
            const isEmpty = cart.length === 0;
            document.getElementById('finalize-sale-button').disabled = isEmpty;
            document.getElementById('generate-quote-button').disabled = isEmpty;
        }

        // Finaliza la venta, la registra y genera el PDF
        async function finalizeSale() {
            if (cart.length === 0) return;
            const button = document.getElementById('finalize-sale-button');
            const buttonText = document.getElementById('sale-button-text');
            const loader = document.getElementById('sale-loader');
            buttonText.classList.add('hidden');
            loader.classList.remove('hidden');
            button.disabled = true;

            const saleData = {
                action: 'recordSale',
                data: {
                    customer: { name: document.getElementById('customer-name').value, contact: document.getElementById('customer-contact').value, id: document.getElementById('customer-id').value },
                    items: cart.map(item => ({ Nombre: item['Nombre'], SKU: item['SKU'], cantidad: item.quantity, precio: item.customPrice })),
                    total: cart.reduce((sum, item) => sum + (item.quantity * item.customPrice), 0)
                }
            };
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify(saleData)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    generateSalePDF(result.saleId, saleData.data);
                    
                    // Actualización local de datos para no tener que recargar todo
                    const newSale = {
                        'Nro. Venta': result.saleId,
                        'Fecha de Venta': new Date().toLocaleDateString('es-BO'),
                        'Nombre Cliente': saleData.data.customer.name || 'N/A',
                        'Contacto': saleData.data.customer.contact || 'N/A',
                        'NIT/CI': saleData.data.customer.id || 'N/A',
                        'Total Venta': saleData.data.total,
                        'Productos Vendidos (JSON)': JSON.stringify(saleData.data.items),
                        'Estado': 'Completada'
                    };
                    sales.unshift(newSale);

                    cart.forEach(cartItem => {
                        const productIndex = products.findIndex(p => p.SKU === cartItem.SKU && p.Nombre === cartItem.Nombre);
                        if (productIndex !== -1) {
                            products[productIndex].Cantidad -= cartItem.quantity;
                        }
                    });

                    // Limpiar interfaz
                    cart = [];
                    renderCart();
                    document.getElementById('customer-form').reset();
                    renderSalesResults();
                    displayNextSaleId();

                } else {
                    alert(`Error al registrar la venta: ${result.message}`);
                }
            } catch (error) {
                console.error('Error de red al registrar la venta.', error);
                alert('Error de red al registrar la venta. Revisa la consola para más detalles.');
            } finally {
                buttonText.classList.remove('hidden');
                loader.classList.add('hidden');
                button.disabled = cart.length === 0;
            }
        }

        // Genera un PDF de Nota de Venta
        function generateSalePDF(saleId, saleData) {
            generateDocumentPDF('Nota de Venta', `Nr: ${saleId}`, saleData);
        }

        // Maneja el clic en el botón de cotización
        function handleGenerateQuote() {
            if (cart.length === 0) {
                alert("El carrito está vacío. Añade productos para generar una cotización.");
                return;
            }

            const quoteData = {
                customer: { 
                    name: document.getElementById('customer-name').value, 
                    contact: document.getElementById('customer-contact').value, 
                    id: document.getElementById('customer-id').value 
                },
                items: cart.map(item => ({ 
                    Nombre: item['Nombre'], 
                    SKU: item['SKU'], 
                    cantidad: item.quantity, 
                    precio: item.customPrice 
                })),
                total: cart.reduce((sum, item) => sum + (item.quantity * item.customPrice), 0)
            };
            
            generateQuotePDF(quoteData);
        }

        // Genera un PDF de Cotización
        function generateQuotePDF(quoteData) {
            generateDocumentPDF('Cotización', 'Válido por 24hrs.', quoteData, 'Cotizacion');
        }

        // Función genérica para crear PDFs (Venta o Cotización)
        function generateDocumentPDF(docType, docIdentifier, data, filePrefix = 'Nota_Venta') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageW = doc.internal.pageSize.getWidth();
            const margin = 14;
            const headerW = pageW - (margin * 2);
            const headerH = 30;
            const r = 3; 
            
            // Encabezado
            doc.setFillColor('#303c54');
            doc.roundedRect(margin, margin, headerW, headerH, r, r, 'F');
            doc.setTextColor('#FFFFFF');

            let textStartX = margin + 5;
            if (preloadedLogo) {
                const logoH = 12; 
                const logoW = (preloadedLogo.width / preloadedLogo.height) * logoH;
                const logoY = margin + (headerH - logoH) / 2;
                doc.addImage(preloadedLogo.dataURL, 'PNG', margin + 5, logoY, logoW, logoH, undefined, 'FAST');
                textStartX = margin + logoW + 8;
            }
            
            doc.setFontSize(17.6);
            doc.text("ArelyShop", textStartX, margin + 15);
            doc.setFontSize(8.8);
            doc.text("Santa Cruz de la Sierra, Bolivia", textStartX, margin + 21);

            doc.setFontSize(16);
            doc.text(docType, pageW - margin - 5, margin + 12, { align: 'right' });
            doc.setFontSize(10);
            doc.text(docIdentifier, pageW - margin - 5, margin + 18, { align: 'right' });
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-BO')}`, pageW - margin - 5, margin + 24, { align: 'right' });

            // Cuerpo
            const startY = margin + headerH + 10;
            doc.setTextColor('#000000');
            doc.setFontSize(12);
            doc.text("Datos del Cliente:", margin, startY);
            doc.setFontSize(10);
            
            const customerInfo = `Nombre: ${data.customer.name || 'N/A'}   |   Contacto: ${data.customer.contact || 'N/A'}   |   NIT/CI: ${data.customer.id || 'N/A'}`;
            doc.text(customerInfo, margin, startY + 8);
            
            // Tabla de productos
            const tableColumn = ["Cant.", "Descripción", "P. Unit.", "Subtotal"];
            const tableRows = [];
            data.items.forEach(item => {
                const itemData = [ item.cantidad, item.Nombre, `Bs ${item.precio.toFixed(2)}`, `Bs ${(item.cantidad * item.precio).toFixed(2)}` ];
                tableRows.push(itemData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows, 
                startY: startY + 15, 
                margin: { left: margin, right: margin },
                headStyles: { fillColor: '#cdcdcd', textColor: '#000000' }
            });
            
            // Pie de página
            const finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(14);
            doc.text("TOTAL:", margin, finalY + 15);
            doc.text(`Bs ${data.total.toFixed(2)}`, pageW - margin, finalY + 15, { align: 'right' });
            
            doc.setFontSize(10);
            const thankYouMessage = filePrefix === 'Cotizacion' ? "¡Gracias por su interés!" : "¡Gracias por su compra!";
            doc.text(thankYouMessage, pageW / 2, finalY + 30, { align: 'center' });
            doc.text("Visita nuestra tienda online: arelyshopbo.mitiendanube.com", pageW / 2, finalY + 35, { align: 'center' });
            
            if (preloadedQr) {
                const qrSize = 25;
                const qrX = (pageW - qrSize) / 2;
                const qrY = finalY + 40;
                doc.addImage(preloadedQr.dataURL, 'JPEG', qrX, qrY, qrSize, qrSize, undefined, 'FAST');
            }

            // Guardar el archivo
            const customerName = data.customer.name.trim() ? data.customer.name.trim().replace(/ /g, "_") : "sin-nombre";
            const fileName = `${filePrefix}_${docType === 'Nota de Venta' ? docIdentifier.split(': ')[1] : customerName}.pdf`;
            doc.save(fileName);
        }

        // Maneja el envío del formulario para añadir un nuevo producto
        async function handleAddProduct(e) {
            e.preventDefault();
            const form = document.getElementById('inventory-form');
            const button = document.getElementById('inventory-submit-button');
            const buttonText = document.getElementById('inventory-button-text');
            const loader = document.getElementById('inventory-loader');
            buttonText.classList.add('hidden');
            loader.classList.remove('hidden');
            button.disabled = true;
            
            const formData = new FormData(form);
            const productData = {};
            formData.forEach((value, key) => { productData[key] = value; });
            const payload = { action: 'addProduct', data: productData };
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Producto registrado con éxito.');
                    form.reset();
                    fetchProducts(); // Recargar productos para tener el nuevo
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error de red al añadir producto.', error);
                alert('Error de red al añadir producto.');
            } finally {
                buttonText.classList.remove('hidden');
                loader.classList.add('hidden');
                button.disabled = false;
            }
        }
        
        // Muestra los resultados de la búsqueda de ventas
        function renderSalesResults() {
            const searchTerm = document.getElementById('search-sales-input').value.toLowerCase();
            const container = document.getElementById('sales-results-container');
            container.innerHTML = '';
            
            const filteredSales = sales.filter(s => 
                s['Nro. Venta']?.toLowerCase().includes(searchTerm) ||
                s['Nombre Cliente']?.toLowerCase().includes(searchTerm) ||
                s['Contacto']?.toString().toLowerCase().includes(searchTerm)
            );

            if (filteredSales.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No se encontraron ventas.</p>';
                return;
            }

            filteredSales.forEach(sale => {
                const isAnnulled = sale['Estado'] === 'Anulada';
                const statusText = isAnnulled ? 'Anulada' : 'Completada';
                const statusColor = isAnnulled ? 'bg-red-500 text-white' : 'bg-green-500 text-white';
                const card = document.createElement('div');
                card.className = `p-4 border rounded-lg ${isAnnulled ? 'bg-gray-200 opacity-70' : 'bg-white'}`;
                
                let productsHtml = '<ul>';
                try {
                    const saleProducts = JSON.parse(sale['Productos Vendidos (JSON)']);
                    saleProducts.forEach(p => {
                        const price = p.precio !== undefined ? parseFloat(p.precio).toFixed(2) : 'N/A';
                        productsHtml += `<li class="text-xs">${p.cantidad} x ${p.Nombre} @ Bs ${price}</li>`;
                    });
                } catch(e) { productsHtml += '<li>Error al leer productos</li>'; }
                productsHtml += '</ul>';
                
                const totalVenta = sale['Total Venta'] !== undefined ? parseFloat(sale['Total Venta']).toFixed(2) : 'N/A';
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-lg">Venta ${sale['Nro. Venta']}</p>
                            <p class="text-sm text-gray-600">${sale['Fecha de Venta']} - ${sale['Nombre Cliente']} (${sale['Contacto'] || 'N/A'})</p>
                            <p class="font-semibold text-blue-600">Total: Bs ${totalVenta}</p>
                        </div>
                        <div class="text-right">
                             <span class="font-semibold text-sm px-2 py-1 rounded-lg ${statusColor}">${statusText}</span>
                             <div class="mt-2 flex space-x-2 justify-end">
                                <button onclick="reprintSale('${sale['Nro. Venta']}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700">Reimprimir</button>
                                <button onclick="openAnnulConfirmModal('${sale['Nro. Venta']}')" class="text-xs bg-red-600 text-white px-3 py-1 rounded-lg hover:bg-red-700 disabled:bg-gray-400" ${isAnnulled ? 'disabled' : ''}>Anular</button>
                             </div>
                        </div>
                    </div>
                    <div class="mt-2 text-sm">${productsHtml}</div>
                `;
                container.appendChild(card);
            });
        }

        // Reimprime el PDF de una venta pasada
        function reprintSale(saleId) {
            const saleToReprint = sales.find(s => s['Nro. Venta'] === saleId);
            if (!saleToReprint) {
                alert("Venta no encontrada para reimprimir.");
                return;
            }

            try {
                const saleData = {
                    customer: {
                        name: saleToReprint['Nombre Cliente'],
                        contact: saleToReprint['Contacto'],
                        id: saleToReprint['NIT/CI']
                    },
                    items: JSON.parse(saleToReprint['Productos Vendidos (JSON)']),
                    total: parseFloat(saleToReprint['Total Venta'])
                };
                generateSalePDF(saleId, saleData);
            } catch (error) {
                console.error("Error al preparar los datos para reimprimir el PDF:", error);
                alert("No se pudo generar el PDF para esta venta.");
            }
        }

        // Abre el modal para confirmar la anulación de una venta
        function openAnnulConfirmModal(saleId) {
            saleIdToAnnul = saleId;
            document.getElementById('annul-modal-text').textContent = `¿Estás seguro de que quieres anular la venta ${saleId}? Esta acción no se puede deshacer y el stock será restaurado.`;
            document.getElementById('annul-confirm-modal').classList.remove('hidden');
        }

        // Envía la solicitud para anular la venta al backend
        async function annulSaleInBackend(saleId) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {'Content-Type': 'text/plain;charset=utf-8'},
                    body: JSON.stringify({ action: 'annulSale', data: { saleId: saleId } })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message);
                    // Recargar datos para reflejar los cambios
                    fetchSales();
                    fetchProducts();
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error de red al anular la venta.', error);
                alert('Error de red al anular la venta.');
            }
        }
    </script>
</body>
</html>
